{
  "hash": "dbf867b41fc4d5141e6751c837e72ca6",
  "result": {
    "markdown": "---\ntitle: 数据分析\n---\n\n\n\n本节主要介绍空间数据分析的方法，分为非空间数据分析和空间数据分析两部分。\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlondonhp <- rgdal::readOGR(\"data/LNHP03.shp\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nPlease note that rgdal will be retired during October 2023,\nplan transition to sf/stars/terra functions using GDAL and PROJ\nat your earliest convenience.\nSee https://r-spatial.org/r/2023/05/15/evolution4.html and https://github.com/r-spatial/evolution\nrgdal: version: 1.6-7, (SVN revision 1203)\nGeospatial Data Abstraction Library extensions to R successfully loaded\nLoaded GDAL runtime: GDAL 3.5.3, released 2022/10/21\nPath to GDAL shared files: /Library/Frameworks/R.framework/Versions/4.2-arm64/Resources/library/rgdal/gdal\n GDAL does not use iconv for recoding strings.\nGDAL binary built with GEOS: TRUE \nLoaded PROJ runtime: Rel. 9.1.0, September 1st, 2022, [PJ_VERSION: 910]\nPath to PROJ shared files: /Library/Frameworks/R.framework/Versions/4.2-arm64/Resources/library/rgdal/proj\nPROJ CDN enabled: TRUE\nLinking to sp version:1.6-1\nTo mute warnings of possible GDAL/OSR exportToProj4() degradation,\nuse options(\"rgdal_show_exportToProj4_warnings\"=\"none\") before loading sp or rgdal.\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: OGR support is provided by the sf and terra packages among others\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: OGR support is provided by the sf and terra packages among others\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: OGR support is provided by the sf and terra packages among others\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: OGR support is provided by the sf and terra packages among others\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: OGR support is provided by the sf and terra packages among others\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: OGR support is provided by the sf and terra packages among others\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: OGR support is provided by the sf and terra packages among others\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\nOGR data source with driver: ESRI Shapefile \nSource: \"/Users/yigong/Documents/RTraining/data/LNHP03.shp\", layer: \"LNHP03\"\nwith 2108 features\nIt has 17 fields\n```\n:::\n:::\n\n\n数据集 `londonborough` 数据包含了该地区的行政边界，使用之前需要先矫正一下坐标系。\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(sp)\ndata(LondonBorough, package = \"GWmodel\")\nproj4string(londonborough) <- proj4string(londonhp)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tmap)\n```\n:::\n\n\n## 相关分析\n\n相关分析是分析变量之间的相关性，从而为回归分析的变量选择提供依据。\n进行相关分析的包有很多，这里主要介绍 `PerformanceAnalytics` 的 `chart.Correlation()` 函数。该函数的特点是提供的信息比较多，有散点图、直方图、相关系数值等，而且相关系数值的字体大小会随着相关系数的大小而变化。\n\n\n::: {.cell}\n\n```{.r .cell-code}\nPerformanceAnalytics::chart.Correlation(londonhp@data[, c(\"PURCHASE\", \"BATH2\", \"FLOORSZ\", \"PROF\", \"UNEMPLOY\")], histogram = T)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in par(usr): argument 1 does not name a graphical parameter\n\nWarning in par(usr): argument 1 does not name a graphical parameter\n\nWarning in par(usr): argument 1 does not name a graphical parameter\n\nWarning in par(usr): argument 1 does not name a graphical parameter\n\nWarning in par(usr): argument 1 does not name a graphical parameter\n\nWarning in par(usr): argument 1 does not name a graphical parameter\n\nWarning in par(usr): argument 1 does not name a graphical parameter\n\nWarning in par(usr): argument 1 does not name a graphical parameter\n\nWarning in par(usr): argument 1 does not name a graphical parameter\n\nWarning in par(usr): argument 1 does not name a graphical parameter\n```\n:::\n\n::: {.cell-output-display}\n![](04-数据分析_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n由此我们可以看到，`PURCHASE` 变量和 `BATH2` `FLOORSZ` `PROF` 三个变量相关性比较强。\n\n该函数默认使用皮尔逊相关系数，如果像计算斯皮尔曼相关系数，则使用 `method` 参数进行指定。\n\n\n::: {.cell}\n\n```{.r .cell-code}\nPerformanceAnalytics::chart.Correlation(londonhp@data[, c(\"PURCHASE\", \"BATH2\", \"FLOORSZ\", \"PROF\", \"UNEMPLOY\")], histogram = T, method = \"spearman\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in cor.test.default(as.numeric(x), as.numeric(y), method = method):\n无法给连结计算精確p值\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in par(usr): argument 1 does not name a graphical parameter\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in cor.test.default(as.numeric(x), as.numeric(y), method = method):\n无法给连结计算精確p值\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in par(usr): argument 1 does not name a graphical parameter\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in cor.test.default(as.numeric(x), as.numeric(y), method = method):\n无法给连结计算精確p值\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in par(usr): argument 1 does not name a graphical parameter\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in cor.test.default(as.numeric(x), as.numeric(y), method = method):\n无法给连结计算精確p值\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in par(usr): argument 1 does not name a graphical parameter\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in cor.test.default(as.numeric(x), as.numeric(y), method = method):\n无法给连结计算精確p值\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in par(usr): argument 1 does not name a graphical parameter\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in cor.test.default(as.numeric(x), as.numeric(y), method = method):\n无法给连结计算精確p值\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in par(usr): argument 1 does not name a graphical parameter\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in cor.test.default(as.numeric(x), as.numeric(y), method = method):\n无法给连结计算精確p值\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in par(usr): argument 1 does not name a graphical parameter\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in cor.test.default(as.numeric(x), as.numeric(y), method = method):\n无法给连结计算精確p值\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in par(usr): argument 1 does not name a graphical parameter\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in cor.test.default(as.numeric(x), as.numeric(y), method = method):\n无法给连结计算精確p值\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in par(usr): argument 1 does not name a graphical parameter\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in cor.test.default(as.numeric(x), as.numeric(y), method = method):\n无法给连结计算精確p值\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in par(usr): argument 1 does not name a graphical parameter\n```\n:::\n\n::: {.cell-output-display}\n![](04-数据分析_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n## 空间相关分析\n\n空间相关分析，主要根据全局莫兰指数和局部莫兰指数进行分析。主要用到的函数包为 `spdep` 包。\n\n\n::: {.cell scrolled='true'}\n\n```{.r .cell-code}\nlibrary(spdep)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n载入需要的程辑包：spData\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nTo access larger datasets in this package, install the spDataLarge\npackage with: `install.packages('spDataLarge',\nrepos='https://nowosad.github.io/drat/', type='source')`\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n载入需要的程辑包：sf\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nLinking to GEOS 3.11.0, GDAL 3.5.3, PROJ 9.1.0; sf_use_s2() is TRUE\n```\n:::\n:::\n\n\n### 全局空间自相关\n\n莫兰指数的定义如下：$$ I = \\frac{n}{\\sum_i \\sum_j w_{ij}} \\frac{ \\sum_i \\sum_j w_{ij} (z_i - \\bar{z})(z_j - \\bar{z}) }{ \\sum_i (z_i - \\bar{z})^2 } $$\n其中 $w$ 为根据空间邻域计算的权重矩阵。\n\n在 R 中，该值的计算方法是\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlondonhp.nb <- knn2nb(knearneigh(londonhp, k = 4, longlat = F))\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in knearneigh(londonhp, k = 4, longlat = F): knearneigh: identical\npoints found\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in knearneigh(londonhp, k = 4, longlat = F): knearneigh: kd_tree not\navailable for identical points\n```\n:::\n\n```{.r .cell-code}\nlondonhp.nb.s <- make.sym.nb(londonhp.nb)\nmoran.test(londonhp$PURCHASE, listw = nb2listw(londonhp.nb.s))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n\tMoran I test under randomisation\n\ndata:  londonhp$PURCHASE  \nweights: nb2listw(londonhp.nb.s)    \n\nMoran I statistic standard deviate = 21.813, p-value < 2.2e-16\nalternative hypothesis: greater\nsample estimates:\nMoran I statistic       Expectation          Variance \n     0.3021153755     -0.0004746084      0.0001924277 \n```\n:::\n:::\n\n\n> 中间涉及到 `knn2nb` `knearneigh` `make.sym.nb` `nb2listw` 几个函数，都是用来生成空间邻域权重矩阵的，具体含义和使用方法请查看帮助文档。\n\n在结果中可以看到，莫兰指数 $I$ 的 $p$ 值很小，表示数据中含有自相关性；否则即使 $I$ 不是 0，也不能认为有相关性。\n然后根据莫兰指数 $I$ 的值，判断相关性的类型：\n\n- $I > 0$ 表示正相关\n- $I < 0$ 表示负相关\n\n除了莫兰指数以外，还有 Geary 系数也比较常用，该系数的用法请参考《R 语言空间统计与分析实践教程》。\n\n### 局部空间自相关\n\n局部空间自相关使用局部莫兰指数，其定义如下 $$ I_i = \\frac{n}{\\sum_j w_{ij}} \\frac{ \\sum_j w_{ij} (z_i - \\bar{z})(z_j - \\bar{z}) }{ \\sum_k (z_k - \\bar{z})^2 } $$\n其中 $w$ 为根据空间邻域计算的权重矩阵。\n\n在 R 中使用 `localmoran()` 函数进行计算，\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlondonhp.localmoran.PURCHASE <- localmoran(londonhp$PURCHASE, listw = nb2listw(londonhp.nb.s, style = \"W\"))\nhead(londonhp.localmoran.PURCHASE)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n           Ii          E.Ii      Var.Ii       Z.Ii Pr(z != E(Ii))\n1  0.55308735 -4.303136e-04 0.226354757  1.1634204      0.2446590\n2  0.51607560 -3.442008e-04 0.181073053  1.2136011      0.2249001\n3  0.66992835 -1.355265e-03 0.712240427  0.7954131      0.4263732\n4 -0.16735547 -8.740320e-05 0.045991853 -0.7799604      0.4354142\n5  0.05380860 -3.747224e-04 0.197123515  0.1220384      0.9028686\n6  0.03048876 -6.919136e-06 0.003641165  0.5053801      0.6132919\n```\n:::\n:::\n\n\n下面我们可以将其在地图上进行可视化，来观察变量的局部相关性分布情况。\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlondonhp.localmoran.PURCHASE.sdf <- data.frame(londonhp@coords, londonhp.localmoran.PURCHASE)\ncoordinates(londonhp.localmoran.PURCHASE.sdf) <- ~ coords.x1 + coords.x2\nproj4string(londonhp.localmoran.PURCHASE.sdf) <- proj4string(londonhp)\ntm_shape(londonborough) + tm_polygons(col = \"white\") + tm_shape(londonhp.localmoran.PURCHASE.sdf) + tm_symbols(col = \"Ii\", size = 0.2)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nVariable(s) \"Ii\" contains positive and negative values, so midpoint is set to 0. Set midpoint = NA to show the full spectrum of the color palette.\n```\n:::\n\n::: {.cell-output-display}\n![](04-数据分析_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n函数 `moran.plot` 用于辅助查看空间自相关特征，使用方法如下\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmoran.plot(londonhp$PURCHASE, nb2listw(londonhp.nb.s, style = \"W\"), pch = 19)\n```\n\n::: {.cell-output-display}\n![](04-数据分析_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n根据点集落入的象限，可以分析空间自相关特征。\n\n## 地理加权分析\n\n地理加权分析，其方法主要由 `GWmodel` 包提供，包括地理加权汇总统计分析（GWSS）、地理加权回归分析（GWR）、地理加权主成分分析（GWPCA）、地理加权判别分析（GWDA）等。\n不同地分析方法分别有不同的作用，需要搭配使用。\n\n\n::: {.cell scrolled='true'}\n\n```{.r .cell-code}\nlibrary(GWmodel)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n载入需要的程辑包：maptools\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nChecking rgeos availability: TRUE\nPlease note that 'maptools' will be retired during 2023,\nplan transition at your earliest convenience;\nsome functionality will be moved to 'sp'.\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n载入需要的程辑包：robustbase\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n载入需要的程辑包：Rcpp\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n载入需要的程辑包：spatialreg\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n载入需要的程辑包：Matrix\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n\n载入程辑包：'spatialreg'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following objects are masked from 'package:spdep':\n\n    get.ClusterOption, get.coresOption, get.mcOption,\n    get.VerboseOption, get.ZeroPolicyOption, set.ClusterOption,\n    set.coresOption, set.mcOption, set.VerboseOption,\n    set.ZeroPolicyOption\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWelcome to GWmodel version 2.2-9.\n```\n:::\n:::\n\n\n### GWR\n\n地理加权回归分析是考虑空间异质性的回归方法，其回归方程是 $$ y_i = \\beta_{i0} + \\sum_{k=1}^{K}\\beta_{ik}x_{ik} + \\epsilon_i $$\n其中 $ y_i $ 是在位置 $i$ 处的因变量； $ x_{ik} $ 是位置 $i$ 上第 $k$ 个自变量; $ K $ 自变量总数；$ \\beta_{i0} $ 是位置 $i$ 上的截距；$\\beta_{ik}$ 位置 $i$ 上第 $k$ 个自变量的回归系数；$ \\epsilon_i $ 是位置 $i$ 上的随机误差，服从正态分布。 \n\n其解算方法是加权最小二乘，即 $$ \\hat{\\beta}_i = \\left( X^T W_i X \\right)^{-1} \\left( X^T W_i y \\right) $$\n其中 $w_{ij}$ 通过核函数和回归点 $i,j$ 之间的距离计算。距离一般是欧氏距离，或者路网距离、通勤时间等。核函数主要有以下几种：\n\n- gaussian 非截断型带宽  $$w_{ij} = \\exp\\left[-\\frac{1}{2}\\left( \\frac{d_{ij}}{b} \\right)^2 \\right]$$\n- bisquare 截断型带宽:  $$w_{ij} = \\left\\{ \\begin{array}{ll} \\left(1 - \\frac{d_{ij}^2}{b^2} \\right)^2, & \\mathrm{if} d_{ij} \\leq b \\\\ 0, & \\mathrm{otherwise} \\end{array}  \\right.$$\n- triqurbe 截断型带宽: $$w_{ij} = \\left\\{ \\begin{array}{ll} \\left(1 - \\frac{d_{ij}^2}{b^3} \\right)^3, & \\mathrm{if} d_{ij} \\leq b \\\\ 0, & \\mathrm{otherwise} \\end{array}  \\right.$$\n\n进行 GWR 分析的方法主要有三步：模型优选、带宽优选、模型拟合。前两步主要是用于选择一个最优参数，其结果是参考性的。\n\n#### 模型优选\n\n使用 `gwr.model.selection()` 函数进行模型优选，该函数需要指定因变量和自变量。\n\n\n::: {.cell scrolled='true'}\n\n```{.r .cell-code}\nlondonhp.indep.vars <- colnames(londonhp@data)[-1]\nlondonhp.depen.vars <- colnames(londonhp@data)[1]\nlondonhp.model.sel <- gwr.model.selection(DeVar = londonhp.depen.vars, InDeVars = londonhp.indep.vars, data = londonhp, \n                                          bw = Inf, adaptive = T, kernel = \"gaussian\", longlat = F)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nNow calibrating the model: \n PURCHASE~FLOORSZ \nNow calibrating the model: \n PURCHASE~TYPETRRD \nNow calibrating the model: \n PURCHASE~TYPEBNGLW \nNow calibrating the model: \n PURCHASE~TYPEFLAT \nNow calibrating the model: \n PURCHASE~BLDPWW1 \nNow calibrating the model: \n PURCHASE~BLDPOSTW \nNow calibrating the model: \n PURCHASE~BLD60S \nNow calibrating the model: \n PURCHASE~BLD70S \nNow calibrating the model: \n PURCHASE~BLD80S \nNow calibrating the model: \n PURCHASE~BATH2 \nNow calibrating the model: \n PURCHASE~BEDS2 \nNow calibrating the model: \n PURCHASE~GARAGE1 \nNow calibrating the model: \n PURCHASE~CENTHEAT \nNow calibrating the model: \n PURCHASE~UNEMPLOY \nNow calibrating the model: \n PURCHASE~PROF \nNow calibrating the model: \n PURCHASE~BLDINTW \nNow calibrating the model: \n PURCHASE~FLOORSZ+TYPETRRD \nNow calibrating the model: \n PURCHASE~FLOORSZ+TYPEBNGLW \nNow calibrating the model: \n PURCHASE~FLOORSZ+TYPEFLAT \nNow calibrating the model: \n PURCHASE~FLOORSZ+BLDPWW1 \nNow calibrating the model: \n PURCHASE~FLOORSZ+BLDPOSTW \nNow calibrating the model: \n PURCHASE~FLOORSZ+BLD60S \nNow calibrating the model: \n PURCHASE~FLOORSZ+BLD70S \nNow calibrating the model: \n PURCHASE~FLOORSZ+BLD80S \nNow calibrating the model: \n PURCHASE~FLOORSZ+BATH2 \nNow calibrating the model: \n PURCHASE~FLOORSZ+BEDS2 \nNow calibrating the model: \n PURCHASE~FLOORSZ+GARAGE1 \nNow calibrating the model: \n PURCHASE~FLOORSZ+CENTHEAT \nNow calibrating the model: \n PURCHASE~FLOORSZ+UNEMPLOY \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF \nNow calibrating the model: \n PURCHASE~FLOORSZ+BLDINTW \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+TYPETRRD \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+TYPEBNGLW \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+TYPEFLAT \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+BLDPWW1 \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+BLDPOSTW \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+BLD60S \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+BLD70S \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+BLD80S \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+BATH2 \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+BEDS2 \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+GARAGE1 \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+CENTHEAT \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+BLDINTW \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+TYPETRRD \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+TYPEBNGLW \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+TYPEFLAT \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BLDPWW1 \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BLDPOSTW \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BLD60S \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BLD70S \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BLD80S \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2 \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BEDS2 \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+GARAGE1 \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+CENTHEAT \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BLDINTW \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+TYPETRRD \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+TYPEBNGLW \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+TYPEFLAT \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLDPWW1 \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLDPOSTW \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD60S \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD80S \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BEDS2 \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+GARAGE1 \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+CENTHEAT \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLDINTW \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+TYPETRRD \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+TYPEBNGLW \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+TYPEFLAT \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLDPWW1 \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLDPOSTW \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD80S \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BEDS2 \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+GARAGE1 \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+CENTHEAT \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLDINTW \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPETRRD \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEBNGLW \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+BLDPWW1 \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+BLDPOSTW \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+BLD80S \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+BEDS2 \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+GARAGE1 \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+CENTHEAT \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+BLDINTW \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+TYPETRRD \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+TYPEBNGLW \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+BLDPWW1 \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+BLDPOSTW \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+BLD80S \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+BEDS2 \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+GARAGE1 \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+CENTHEAT \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+BLDINTW \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+TYPETRRD+TYPEBNGLW \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+TYPETRRD+BLDPWW1 \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+TYPETRRD+BLDPOSTW \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+TYPETRRD+BLD80S \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+TYPETRRD+BEDS2 \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+TYPETRRD+GARAGE1 \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+TYPETRRD+CENTHEAT \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+TYPETRRD+BLDINTW \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+TYPETRRD+BLDPOSTW+TYPEBNGLW \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+TYPETRRD+BLDPOSTW+BLDPWW1 \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+TYPETRRD+BLDPOSTW+BLD80S \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+TYPETRRD+BLDPOSTW+BEDS2 \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+TYPETRRD+BLDPOSTW+GARAGE1 \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+TYPETRRD+BLDPOSTW+CENTHEAT \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+TYPETRRD+BLDPOSTW+BLDINTW \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+TYPETRRD+BLDPOSTW+CENTHEAT+TYPEBNGLW \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+TYPETRRD+BLDPOSTW+CENTHEAT+BLDPWW1 \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+TYPETRRD+BLDPOSTW+CENTHEAT+BLD80S \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+TYPETRRD+BLDPOSTW+CENTHEAT+BEDS2 \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+TYPETRRD+BLDPOSTW+CENTHEAT+GARAGE1 \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+TYPETRRD+BLDPOSTW+CENTHEAT+BLDINTW \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+TYPETRRD+BLDPOSTW+CENTHEAT+BLDINTW+TYPEBNGLW \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+TYPETRRD+BLDPOSTW+CENTHEAT+BLDINTW+BLDPWW1 \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+TYPETRRD+BLDPOSTW+CENTHEAT+BLDINTW+BLD80S \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+TYPETRRD+BLDPOSTW+CENTHEAT+BLDINTW+BEDS2 \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+TYPETRRD+BLDPOSTW+CENTHEAT+BLDINTW+GARAGE1 \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+TYPETRRD+BLDPOSTW+CENTHEAT+BLDINTW+GARAGE1+TYPEBNGLW \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+TYPETRRD+BLDPOSTW+CENTHEAT+BLDINTW+GARAGE1+BLDPWW1 \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+TYPETRRD+BLDPOSTW+CENTHEAT+BLDINTW+GARAGE1+BLD80S \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+TYPETRRD+BLDPOSTW+CENTHEAT+BLDINTW+GARAGE1+BEDS2 \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+TYPETRRD+BLDPOSTW+CENTHEAT+BLDINTW+GARAGE1+TYPEBNGLW+BLDPWW1 \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+TYPETRRD+BLDPOSTW+CENTHEAT+BLDINTW+GARAGE1+TYPEBNGLW+BLD80S \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+TYPETRRD+BLDPOSTW+CENTHEAT+BLDINTW+GARAGE1+TYPEBNGLW+BEDS2 \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+TYPETRRD+BLDPOSTW+CENTHEAT+BLDINTW+GARAGE1+TYPEBNGLW+BEDS2+BLDPWW1 \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+TYPETRRD+BLDPOSTW+CENTHEAT+BLDINTW+GARAGE1+TYPEBNGLW+BEDS2+BLD80S \nNow calibrating the model: \n PURCHASE~FLOORSZ+PROF+UNEMPLOY+BATH2+BLD70S+BLD60S+TYPEFLAT+TYPETRRD+BLDPOSTW+CENTHEAT+BLDINTW+GARAGE1+TYPEBNGLW+BEDS2+BLD80S+BLDPWW1 \n```\n:::\n\n```{.r .cell-code}\nlondonhp.model.sort <- gwr.model.sort(londonhp.model.sel, length(londonhp.indep.vars), londonhp.model.sel[[2]][,2])\n```\n:::\n\n\n然后根据下面三张图，可以分析究竟应该选择哪个模型\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## 模型列表\ngwr.model.view(DeVar = londonhp.depen.vars, InDeVars = londonhp.indep.vars, londonhp.model.sort[[1]])\n```\n\n::: {.cell-output-display}\n![](04-数据分析_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n\n```{.r .cell-code}\n## 模型 AIC 值\nlondonhp.model.ruler <- londonhp.model.sort[[2]][,2]\nplot(londonhp.model.ruler, type = \"b\", pch = 20, lty = 2)\n```\n\n::: {.cell-output-display}\n![](04-数据分析_files/figure-html/unnamed-chunk-13-2.png){width=672}\n:::\n\n```{.r .cell-code}\n## 模型 AIC 变化\nlondonhp.model.ruler.diff <- c(0, diff(londonhp.model.ruler))\nplot(londonhp.model.ruler.diff, ylim = c(-50, 0))\nabline(h = -3)\ntext(x = 1:length(londonhp.model.ruler.diff), y = londonhp.model.ruler.diff, labels = as.character(1:length(londonhp.model.ruler.diff)))\n```\n\n::: {.cell-output-display}\n![](04-数据分析_files/figure-html/unnamed-chunk-13-3.png){width=672}\n:::\n:::\n\n\n可以看到，第 115 个模型是比较好的模型。下面有两种方法获取该模型，一种是根据第一张图查找 115 号模型的自变量。\n另一种方法是，直接根据输出结果获取表达式。\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlondonhp.model.best <- londonhp.model.sort[[1]][[115]]\nlondonhp.model.formula <- formula(londonhp.model.best[[1]])\nlondonhp.model.indep <- londonhp.model.best[[2]]\nlondonhp.model.formula\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nPURCHASE ~ FLOORSZ + PROF + UNEMPLOY + BATH2 + BLD70S + BLD60S + \n    TYPEFLAT + TYPETRRD + BLDPOSTW + CENTHEAT\n```\n:::\n:::\n\n\n#### 带宽优选\n\n在选好了模型的基础上，使用 `bw.gwr()` 函数进行带宽优选。\n\n\n::: {.cell scrolled='true'}\n\n```{.r .cell-code}\nlondonhp.bw <- bw.gwr(\n  londonhp.model.formula, londonhp,\n  kernel = \"gaussian\", adaptive = T, longlat = F)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nTake a cup of tea and have a break, it will take a few minutes.\n          -----A kind suggestion from GWmodel development group\nAdaptive bandwidth: 1310 CV score: 3.1374e+12 \nAdaptive bandwidth: 818 CV score: 3.045352e+12 \nAdaptive bandwidth: 512 CV score: 2.936046e+12 \nAdaptive bandwidth: 325 CV score: 2.812869e+12 \nAdaptive bandwidth: 207 CV score: 2.678671e+12 \nAdaptive bandwidth: 136 CV score: 2.553181e+12 \nAdaptive bandwidth: 90 CV score: 2.445221e+12 \nAdaptive bandwidth: 64 CV score: 2.368359e+12 \nAdaptive bandwidth: 45 CV score: 2.334825e+12 \nAdaptive bandwidth: 36 CV score: 2.33059e+12 \nAdaptive bandwidth: 28 CV score: 2.370425e+12 \nAdaptive bandwidth: 38 CV score: 2.329224e+12 \nAdaptive bandwidth: 42 CV score: 2.331694e+12 \nAdaptive bandwidth: 37 CV score: 2.330045e+12 \nAdaptive bandwidth: 39 CV score: 2.33098e+12 \nAdaptive bandwidth: 37 CV score: 2.330045e+12 \nAdaptive bandwidth: 38 CV score: 2.329224e+12 \n```\n:::\n:::\n\n\n返回的 `londonhp.bw` 即是最优带宽值。\n\n#### 模型解算\n\n在选好模型和带宽的基础上，使用 `gwr.basic()` 函数解算模型。\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlondonhp.model.gwr <- gwr.basic(\n  londonhp.model.formula, londonhp,\n  bw = londonhp.bw, kernel = \"gaussian\", adaptive = T, longlat = F)\nlondonhp.model.gwr\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n   ***********************************************************************\n   *                       Package   GWmodel                             *\n   ***********************************************************************\n   Program starts at: 2023-06-28 17:11:48 \n   Call:\n   gwr.basic(formula = londonhp.model.formula, data = londonhp, \n    bw = londonhp.bw, kernel = \"gaussian\", adaptive = T, longlat = F)\n\n   Dependent (y) variable:  PURCHASE\n   Independent variables:  FLOORSZ PROF UNEMPLOY BATH2 BLD70S BLD60S TYPEFLAT TYPETRRD BLDPOSTW CENTHEAT\n   Number of data points: 2108\n   ***********************************************************************\n   *                    Results of Global Regression                     *\n   ***********************************************************************\n\n   Call:\n    lm(formula = formula, data = data)\n\n   Residuals:\n    Min      1Q  Median      3Q     Max \n-173205  -22919   -2231   18707  281248 \n\n   Coefficients:\n                 Estimate Std. Error t value Pr(>|t|)    \n   (Intercept) -115426.57    6696.92 -17.236  < 2e-16 ***\n   FLOORSZ        1326.34      37.11  35.743  < 2e-16 ***\n   PROF           3242.26     100.07  32.399  < 2e-16 ***\n   UNEMPLOY       4951.36     436.71  11.338  < 2e-16 ***\n   BATH2         41364.26    3946.35  10.482  < 2e-16 ***\n   BLD70S       -23228.98    3528.55  -6.583 5.80e-11 ***\n   BLD60S       -19744.89    3517.62  -5.613 2.25e-08 ***\n   TYPEFLAT     -20923.34    3035.38  -6.893 7.19e-12 ***\n   TYPETRRD     -16584.53    2592.94  -6.396 1.96e-10 ***\n   BLDPOSTW     -11666.75    3395.45  -3.436 0.000602 ***\n   CENTHEAT       8894.71    3033.81   2.932 0.003406 ** \n\n   ---Significance stars\n   Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1 \n   Residual standard error: 39220 on 2097 degrees of freedom\n   Multiple R-squared: 0.7248\n   Adjusted R-squared: 0.7235 \n   F-statistic: 552.3 on 10 and 2097 DF,  p-value: < 2.2e-16 \n   ***Extra Diagnostic information\n   Residual sum of squares: 3.22509e+12\n   Sigma(hat): 39132.87\n   AIC:  50587.26\n   AICc:  50587.4\n   BIC:  48638.94\n   ***********************************************************************\n   *          Results of Geographically Weighted Regression              *\n   ***********************************************************************\n\n   *********************Model calibration information*********************\n   Kernel function: gaussian \n   Adaptive bandwidth: 38 (number of nearest neighbours)\n   Regression points: the same locations as observations are used.\n   Distance metric: Euclidean distance metric is used.\n\n   ****************Summary of GWR coefficient estimates:******************\n                   Min.    1st Qu.     Median    3rd Qu.     Max.\n   Intercept -318194.10 -129274.95  -66519.16  -26778.49  39622.1\n   FLOORSZ       692.29     998.07    1211.63    1567.23   2299.0\n   PROF          728.46    1842.99    2456.09    3141.38   4659.3\n   UNEMPLOY    -4425.41     537.34    3401.48    7221.86  18305.6\n   BATH2      -33119.69   13067.79   27995.90   42945.77 101046.6\n   BLD70S     -61299.35  -28664.69  -17357.87   -6405.28  25042.9\n   BLD60S     -61162.61  -27967.20  -14947.43   -6644.56  43289.6\n   TYPEFLAT   -74602.25  -35372.44  -26510.37  -16993.47  60502.4\n   TYPETRRD   -64267.65  -21321.71  -14584.03   -9786.92  60897.0\n   BLDPOSTW  -100737.90  -17944.81  -10136.40   -4815.35  24091.5\n   CENTHEAT   -17509.75    3584.70    9495.27   15269.60  37500.1\n   ************************Diagnostic information*************************\n   Number of data points: 2108 \n   Effective number of parameters (2trace(S) - trace(S'S)): 391.1129 \n   Effective degrees of freedom (n-2trace(S) + trace(S'S)): 1716.887 \n   AICc (GWR book, Fotheringham, et al. 2002, p. 61, eq 2.33): 49687.11 \n   AIC (GWR book, Fotheringham, et al. 2002,GWR p. 96, eq. 4.22): 49310.55 \n   BIC (GWR book, Fotheringham, et al. 2002,GWR p. 61, eq. 2.34): 49096.43 \n   Residual sum of squares: 1.555303e+12 \n   R-square value:  0.8672878 \n   Adjusted R-square value:  0.8370379 \n\n   ***********************************************************************\n   Program stops at: 2023-06-28 17:11:49 \n```\n:::\n:::\n\n\n返回结果 `londonhp.model.gwr` 是一个列表，最重要的是以下两个键值对：\n\n- `SDF` 是一个 Spatial\\*DatFrame, 和原始数据的类型一致，包含每个点上的回归系数和截距，以及一些其他信息。\n- `diagnostic` 诊断信息，包含 AIC, $R^2$ 值等，在上述结果输出中也可以看到。\n\n我们可以先将 `SDF` 的值的列名进行输出\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncolnames(londonhp.model.gwr$SDF@data)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n [1] \"Intercept\"     \"FLOORSZ\"       \"PROF\"          \"UNEMPLOY\"     \n [5] \"BATH2\"         \"BLD70S\"        \"BLD60S\"        \"TYPEFLAT\"     \n [9] \"TYPETRRD\"      \"BLDPOSTW\"      \"CENTHEAT\"      \"y\"            \n[13] \"yhat\"          \"residual\"      \"CV_Score\"      \"Stud_residual\"\n[17] \"Intercept_SE\"  \"FLOORSZ_SE\"    \"PROF_SE\"       \"UNEMPLOY_SE\"  \n[21] \"BATH2_SE\"      \"BLD70S_SE\"     \"BLD60S_SE\"     \"TYPEFLAT_SE\"  \n[25] \"TYPETRRD_SE\"   \"BLDPOSTW_SE\"   \"CENTHEAT_SE\"   \"Intercept_TV\" \n[29] \"FLOORSZ_TV\"    \"PROF_TV\"       \"UNEMPLOY_TV\"   \"BATH2_TV\"     \n[33] \"BLD70S_TV\"     \"BLD60S_TV\"     \"TYPEFLAT_TV\"   \"TYPETRRD_TV\"  \n[37] \"BLDPOSTW_TV\"   \"CENTHEAT_TV\"   \"Local_R2\"     \n```\n:::\n:::\n\n\n可见，该变量包含以下列：\n\n- 前 $k$ 列（$k$ 是自变量数+1）是每个要素的回归系数\n- 后面跟着真值 $y$，估计值 $\\hat{y}$，残差值 $\\epsilon$， CV 值和学生残差值\n- 后面跟着 $k$ 个回归系数（包括截距）的标准差\n- 后面跟着 $k$ 个回归系数（包括截距）的 t 检验值\n- 最后一列是局部 $R^2$ 值\n\n我们可以对这些系数进行可视化输出\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntm_shape(londonhp.model.gwr$SDF) + tm_symbols(col = \"Intercept\", size = 0.2)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nVariable(s) \"Intercept\" contains positive and negative values, so midpoint is set to 0. Set midpoint = NA to show the full spectrum of the color palette.\n```\n:::\n\n::: {.cell-output-display}\n![](04-数据分析_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n\n下面我们使用数据集 `LondonBorough` 制作完整的专题图。\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntm_shape(londonborough) + tm_polygons(col = \"white\") + tm_shape(londonhp.model.gwr$SDF) + tm_symbols(col = \"Intercept\", size = 0.2)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nVariable(s) \"Intercept\" contains positive and negative values, so midpoint is set to 0. Set midpoint = NA to show the full spectrum of the color palette.\n```\n:::\n\n::: {.cell-output-display}\n![](04-数据分析_files/figure-html/unnamed-chunk-19-1.png){width=672}\n:::\n:::\n\n\n### GWSS\n\nGWSS 包含以下几类地理加权汇总统计量：\n\n- 局部平均数 $$ \\bar{x}(u_i,v_i) = \\frac{\\sum_j x_j w_{ij}}{\\sum_j w_{ij}} $$\n- 局部标准差  $$ SD(u_i,v_i) = \\frac{\\sqrt{\\sum_j (x_j - \\bar{x}(u,v))^2 w_{ij}}}{\\sum_j w_{ij}} $$\n- 局部方差   $$ Var(u_i,v_i) = \\frac{{\\sum_j (x_j - \\bar{x}(u,v))^2 w_{ij}}}{\\sum_j w_{ij}} $$\n- 局部偏度\n- 局部变异系数\n- 局部协方差 $$ Cov_{x,y}(u_i,v_i) = \\frac{{\\sum_j  w_{ij} (x_j - \\bar{x}_i(u_i,v_i)) (y_j - \\bar{y}_i)(u_i,v_i)}}{\\sum_j w_{ij}} $$\n- 局部皮尔逊相关系数 $$ Corr_{x,y}(u_i,v_i) = \\frac{ Cov_{x,y}(u_i,v_i) }{ SD_x(u_i,v_i) \\times SD_y(u_i,v_i) } $$\n- 局部斯皮尔曼相关系数\n\n函数 `gwss()` 提供该功能。GWSS 的使用没有像 GWR 那么复杂，只是计算几个统计量。使用方法如下\n\n\n::: {.cell scrolled='true'}\n\n```{.r .cell-code}\nlondonhp.gwss <- gwss(londonhp, vars = c(\"PURCHASE\", \"FLOORSZ\", \"PROF\", \"UNEMPLOY\"), \n                      kernel = \"gaussian\", adaptive = TRUE, bw = 100, longlat = F)\nlondonhp.gwss\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n   ***********************************************************************\n   *                       Package   GWmodel                             *\n   ***********************************************************************\n\n   ***********************Calibration information*************************\n\n   Local summary statistics calculated for variables:\n    PURCHASE FLOORSZ PROF UNEMPLOY\n   Number of summary points: 2108\n   Kernel function: gaussian \n   Summary points: the same locations as observations are used.\n   Adaptive bandwidth: 100 (number of nearest neighbours)\n   Distance metric: Euclidean distance metric is used.\n\n   ************************Local Summary Statistics:**********************\n   Summary information for Local means:\n                     Min.    1st Qu.     Median    3rd Qu.       Max.\n   PURCHASE_LM 1.0368e+05 1.2399e+05 1.4048e+05 1.6094e+05 186983.753\n   FLOORSZ_LM  7.4837e+01 8.1833e+01 8.4555e+01 8.7412e+01     92.044\n   PROF_LM     2.8395e+01 3.5084e+01 3.8918e+01 4.2598e+01     50.381\n   UNEMPLOY_LM 3.8043e+00 5.0748e+00 5.9113e+00 6.9467e+00      9.189\n   Summary information for local standard deviation :\n                      Min.    1st Qu.     Median    3rd Qu.       Max.\n   PURCHASE_LSD 41586.5582 56570.5226 68538.3666 80193.7730 96026.1792\n   FLOORSZ_LSD     27.8241    29.8802    31.9630    33.9498    37.3879\n   PROF_LSD         6.4589     8.2712     9.5373    10.8088    13.7212\n   UNEMPLOY_LSD     1.1012     1.6838     2.1262     2.5122     2.9883\n   Summary information for local variance :\n                       Min.    1st Qu.     Median    3rd Qu.       Max.\n   PURCHASE_LVar 1.7294e+09 3.2002e+09 4.6975e+09 6.4310e+09 9.2210e+09\n   FLOORSZ_LVar  7.7418e+02 8.9283e+02 1.0216e+03 1.1526e+03 1.3979e+03\n   PROF_LVar     4.1717e+01 6.8412e+01 9.0961e+01 1.1683e+02 1.8827e+02\n   UNEMPLOY_LVar 1.2126e+00 2.8351e+00 4.5209e+00 6.3110e+00 8.9299e+00\n   Summary information for Local skewness:\n                      Min.   1st Qu.    Median   3rd Qu.   Max.\n   PURCHASE_LSKe  1.424002  1.995719  2.261538  2.443722 3.3553\n   FLOORSZ_LSKe   0.703198  1.117976  1.284149  1.531301 2.1631\n   PROF_LSKe     -0.540195 -0.022425  0.195211  0.495701 0.9970\n   UNEMPLOY_LSKe -0.262581  0.283762  0.720260  1.078178 2.0067\n   Summary information for localized coefficient of variation:\n                   Min. 1st Qu.  Median 3rd Qu.   Max.\n   PURCHASE_LCV 0.40048 0.44784 0.47996 0.50065 0.5392\n   FLOORSZ_LCV  0.31658 0.36421 0.38368 0.40122 0.4390\n   PROF_LCV     0.17034 0.22437 0.24708 0.26904 0.3329\n   UNEMPLOY_LCV 0.24824 0.31042 0.33447 0.37361 0.4660\n   Summary information for localized Covariance and Correlation between these variables:\n                                         Min.     1st Qu.      Median\n   Cov_PURCHASE.FLOORSZ            9.1822e+05  1.2667e+06  1.7095e+06\n   Cov_PURCHASE.PROF               7.9696e+04  1.6391e+05  2.6170e+05\n   Cov_PURCHASE.UNEMPLOY          -4.8018e+04 -3.3010e+04 -2.7481e+04\n   Cov_FLOORSZ.PROF               -3.0740e+01  1.4644e+00  1.4510e+01\n   Cov_FLOORSZ.UNEMPLOY           -1.8184e+01 -9.7601e+00 -6.4650e+00\n   Cov_PROF.UNEMPLOY              -2.4979e+01 -1.5256e+01 -1.1264e+01\n   Corr_PURCHASE.FLOORSZ           6.1369e-01  7.2888e-01  7.6928e-01\n   Corr_PURCHASE.PROF              2.6387e-01  3.3028e-01  3.6297e-01\n   Corr_PURCHASE.UNEMPLOY         -3.5095e-01 -2.3525e-01 -1.9890e-01\n   Corr_FLOORSZ.PROF              -9.2459e-02  5.4290e-03  4.5056e-02\n   Corr_FLOORSZ.UNEMPLOY          -2.7446e-01 -1.6193e-01 -1.0279e-01\n   Corr_PROF.UNEMPLOY             -8.4840e-01 -6.6314e-01 -5.8815e-01\n   Spearman_rho_PURCHASE.FLOORSZ   5.1056e-01  6.3550e-01  7.0561e-01\n   Spearman_rho_PURCHASE.PROF      2.3277e-01  3.3909e-01  3.7563e-01\n   Spearman_rho_PURCHASE.UNEMPLOY -4.1116e-01 -2.8168e-01 -2.2578e-01\n   Spearman_rho_FLOORSZ.PROF      -1.2790e-01 -3.8725e-02 -3.1999e-03\n   Spearman_rho_FLOORSZ.UNEMPLOY  -2.6861e-01 -1.6102e-01 -9.4537e-02\n   Spearman_rho_PROF.UNEMPLOY     -7.7747e-01 -6.4699e-01 -5.7788e-01\n                                      3rd Qu.        Max.\n   Cov_PURCHASE.FLOORSZ            2.0685e+06  2.5674e+06\n   Cov_PURCHASE.PROF               3.2068e+05  5.2653e+05\n   Cov_PURCHASE.UNEMPLOY          -2.2201e+04 -8.8273e+03\n   Cov_FLOORSZ.PROF                2.7657e+01  1.1376e+02\n   Cov_FLOORSZ.UNEMPLOY           -3.5871e+00  4.1757e+00\n   Cov_PROF.UNEMPLOY              -8.5850e+00 -4.7220e+00\n   Corr_PURCHASE.FLOORSZ           8.0060e-01  8.5960e-01\n   Corr_PURCHASE.PROF              3.9862e-01  5.4810e-01\n   Corr_PURCHASE.UNEMPLOY         -1.6069e-01 -9.1500e-02\n   Corr_FLOORSZ.PROF               9.3242e-02  3.4530e-01\n   Corr_FLOORSZ.UNEMPLOY          -5.3033e-02  5.1900e-02\n   Corr_PROF.UNEMPLOY             -5.3682e-01 -3.6490e-01\n   Spearman_rho_PURCHASE.FLOORSZ   7.5496e-01  8.3060e-01\n   Spearman_rho_PURCHASE.PROF      4.2373e-01  5.3690e-01\n   Spearman_rho_PURCHASE.UNEMPLOY -1.7347e-01 -8.1000e-02\n   Spearman_rho_FLOORSZ.PROF       4.1846e-02  2.9670e-01\n   Spearman_rho_FLOORSZ.UNEMPLOY  -5.9230e-02  3.9500e-02\n   Spearman_rho_PROF.UNEMPLOY     -5.2421e-01 -3.6620e-01\n\n   ************************************************************************\n```\n:::\n:::\n\n\n同样，变量 `londonhp.gwss` 是一个列表，其中有一个 `SDF` 的键值对，包含了每个要素上 GWSS 统计量的计算结果。\n\n\n::: {.cell scrolled='true'}\n\n```{.r .cell-code}\ncolnames(londonhp.gwss$SDF@data)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n [1] \"PURCHASE_LM\"                    \"FLOORSZ_LM\"                    \n [3] \"PROF_LM\"                        \"UNEMPLOY_LM\"                   \n [5] \"PURCHASE_LSD\"                   \"FLOORSZ_LSD\"                   \n [7] \"PROF_LSD\"                       \"UNEMPLOY_LSD\"                  \n [9] \"PURCHASE_LVar\"                  \"FLOORSZ_LVar\"                  \n[11] \"PROF_LVar\"                      \"UNEMPLOY_LVar\"                 \n[13] \"PURCHASE_LSKe\"                  \"FLOORSZ_LSKe\"                  \n[15] \"PROF_LSKe\"                      \"UNEMPLOY_LSKe\"                 \n[17] \"PURCHASE_LCV\"                   \"FLOORSZ_LCV\"                   \n[19] \"PROF_LCV\"                       \"UNEMPLOY_LCV\"                  \n[21] \"Cov_PURCHASE.FLOORSZ\"           \"Cov_PURCHASE.PROF\"             \n[23] \"Cov_PURCHASE.UNEMPLOY\"          \"Cov_FLOORSZ.PROF\"              \n[25] \"Cov_FLOORSZ.UNEMPLOY\"           \"Cov_PROF.UNEMPLOY\"             \n[27] \"Corr_PURCHASE.FLOORSZ\"          \"Corr_PURCHASE.PROF\"            \n[29] \"Corr_PURCHASE.UNEMPLOY\"         \"Corr_FLOORSZ.PROF\"             \n[31] \"Corr_FLOORSZ.UNEMPLOY\"          \"Corr_PROF.UNEMPLOY\"            \n[33] \"Spearman_rho_PURCHASE.FLOORSZ\"  \"Spearman_rho_PURCHASE.PROF\"    \n[35] \"Spearman_rho_PURCHASE.UNEMPLOY\" \"Spearman_rho_FLOORSZ.PROF\"     \n[37] \"Spearman_rho_FLOORSZ.UNEMPLOY\"  \"Spearman_rho_PROF.UNEMPLOY\"    \n```\n:::\n:::\n\n\n我们也可以将其进行可视化\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntm_shape(londonborough) + tm_polygons(col = \"white\") + tm_shape(londonhp.gwss$SDF) + tm_symbols(col = \"PURCHASE_LM\", size = 0.2)\n```\n\n::: {.cell-output-display}\n![](04-数据分析_files/figure-html/unnamed-chunk-22-1.png){width=672}\n:::\n\n```{.r .cell-code}\ntm_shape(londonborough) + tm_polygons(col = \"white\") + tm_shape(londonhp.gwss$SDF) + tm_symbols(col = \"Corr_PURCHASE.PROF\", size = 0.2)\n```\n\n::: {.cell-output-display}\n![](04-数据分析_files/figure-html/unnamed-chunk-22-2.png){width=672}\n:::\n:::\n\n\n### GWPCA\n\nGWPCA 是一种局部加权的 PCA 算法，用于分析局部尺度下主成分的不同。\n\n在进行主成分分析之前，我们需要对数据进行归一化处理，处理的方法是\n$$ \\tilde{x}_i = \\frac{x_i - \\bar{x}}{\\mathrm{Var}(x)} $$\n在 R 中，使用 `scale` 函数即可\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlondonhp.scaled <- londonhp\nlondonhp.scaled@data <- as.data.frame(scale(as.matrix(londonhp@data[,c(\"FLOORSZ\", \"PROF\", \"UNEMPLOY\")])))\n```\n:::\n\n\n使用 `gwpca()` 函数进行 GWPCA 解算。\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlondonhp.gwpca <- gwpca(londonhp.scaled, vars = c(\"FLOORSZ\", \"PROF\", \"UNEMPLOY\"), k = 2,\n                        kernel = \"gaussian\", adaptive = TRUE, bw = 100, longlat = F)\nlondonhp.gwpca\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n   ***********************************************************************\n   *                       Package   GWmodel                             *\n   ***********************************************************************\n   Program starts at: 2023-06-28 17:12:01 \n   Call:\n   \n   Variables concerned:  FLOORSZ PROF UNEMPLOY\n   The number of retained components:  2\n   Number of data points: 2108\n   ***********************************************************************\n   *                Results of Principal Components Analysis               *\n   ***********************************************************************\nImportance of components:\n                          Comp.1    Comp.2    Comp.3\nStandard deviation     1.2425881 0.9934353 0.6848803\nProportion of Variance 0.5146751 0.3289713 0.1563537\nCumulative Proportion  0.5146751 0.8436463 1.0000000\n\nLoadings:\n         Comp.1 Comp.2 Comp.3\nFLOORSZ   0.184  0.977  0.105\nPROF      0.688 -0.205  0.696\nUNEMPLOY -0.702  0.055  0.710\n\n   ***********************************************************************\n   *   Results of Geographically Weighted Principal Components Analysis  *\n   ***********************************************************************\n\n   *********************Model calibration information*********************\n   Kernel function for geographically weighting: gaussian \n   Adaptive bandwidth for geographically and temporally  weighting: 100 (number of nearest neighbours)\n   Distance metric for geographically weighting: A distance matrix is specified for this model calibration.\n\n   ****************     Summary of GWPCA information:    *****************\n   Local variance: \n             Min. 1st Qu.  Median 3rd Qu.   Max.\n   Comp.1 0.44818 0.73382 0.91733 1.11706 2.2363\n   Comp.2 0.30006 0.49736 0.59489 0.72957 1.1960\n   Local Proportion of Variance: \n                Min. 1st Qu. Median 3rd Qu.   Max.\n   Comp.1     43.185  51.370 54.606  57.378 64.453\n   Comp.2     27.245  33.347 35.127  37.705 44.821\n   Cumulative 85.087  88.288 89.655  91.399 95.067\n\n   ***********************************************************************\n   Program stops at: 2023-06-28 17:16:04 \n```\n:::\n:::\n\n\n返回值 `londonhp.gwpca` 也是一个列表，主要有以下几个键值对：\n\n- `SDF` : 存储各个要素上的 GWPCA 分析的结果，包含前 k 个主成分的值 `Comp.1_PV` `Comp.2_PV` ... `Comp.$k$_PV`，累积占比 `local_CP`，以及优胜变量 `win_var_PC1` 。\n- `loadings` : 各个要素上的载荷矩阵\n- `gwpca.scores` : 各个要素上的得分值（只有设置了 `score` 参数才有值）\n- `local.PV` : 各个要素上的特征值\n\n我们可以将优胜变量进行可视化\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntm_shape(londonborough) + tm_polygons(col = \"white\") + tm_shape(londonhp.gwpca$SDF) + tm_symbols(col = \"win_var_PC1\", size = 0.2)\n```\n\n::: {.cell-output-display}\n![](04-数据分析_files/figure-html/unnamed-chunk-25-1.png){width=672}\n:::\n:::\n\n\n也可以对载荷矩阵进行可视化，以分析其空间异质性。\n该可视化方法在 `tmap` 包中没有，因此需要使用 `GWmodel` 包中的一个函数绘制，而此时就不能使用 `tmap` 来显示底图，需要使用 `plot()` 函数来显示底图。\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlondonhp.loadings <- londonhp.gwpca$loadings[,,1]\nplot(londonborough, asp = 1, xaxt = \"n\", yaxt = \"n\", xlab = \"\", ylab = \"\", bty = \"n\", col = \"white\")\nglyph.plot(londonhp.loadings, londonhp.gwpca$SDF@coords, add = TRUE)\n```\n\n::: {.cell-output-display}\n![](04-数据分析_files/figure-html/unnamed-chunk-26-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "04-数据分析_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}